<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/logo-doan.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">
    <title>Chi đoàn</title>
</head>

<body>
    <header>
        <img class="logo" src="../picture/logo-tdtu.png" alt="logo-tdtu">
        <img class="logo" src="../picture/logo-doan.png" alt="logo-doan">
        <h1 class="title">HỆ THỐNG ĐOÀN PHÍ TDTU</h1>
    </header>

    <div class="main-container">
        <form id="studentForm">
            <div class="flex-row-container">
                <div class="flex-col-container">
                    <label>Mã sinh viên *</label>
                    <input type="text" id="mssv" maxlength="8" placeholder="Nhập mã sinh viên" required>
                </div>
                <div class="flex-col-container">
                    <label>Số thứ tự</label>
                    <input type="text" id="stt" placeholder="Số thứ tự" readonly>
                </div>
            </div>

            <div class="flex-row-container">
                <div class="flex-col-container">
                    <label>Họ lót</label>
                    <input type="text" id="lastname" placeholder="Họ lót" readonly>
                </div>
                <div class="flex-col-container">
                    <label>Tên</label>
                    <input type="text" id="firstname" placeholder="Tên" readonly>
                </div>
            </div>

            <div class="flex-row-container">
                <div class="flex-col-container">
                    <label>Mã Đoàn khoa</label>
                    <input type="text" id="faculty" placeholder="Đoàn Khoa" readonly>
                </div>
                <div class="flex-col-container">
                    <label>Mã Chi đoàn</label>
                    <input type="text" id="class" placeholder="Chi đoàn" readonly>
                </div>
            </div>

            <div class="flex-row-container">
                <div class="flex-col-container">
                    <label>Đã đóng đến tháng *</label>
                    <select id="month" required>
                        <option value="" disabled selected>Chọn tháng</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                </div>
                <div class="flex-col-container">
                    <label>Đã đóng đến năm *</label>
                    <select id="year" required>
                        <option value="" disabled>Chọn năm</option>
                        <option value="2023">2023</option>
                        <option value="2023">2023</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                        <option value="2028">2028</option>
                        <option value="2029">2029</option>
                        <option value="2030">2030</option>
                    </select>
                </div>
            </div>

            <div class="flex-row-container">
                <div class="flex-col-container">
                    <label>Số tiền cần thu</label>
                    <input type="text" id="fee" placeholder="Số tiền" readonly>
                </div>
                <div class="flex-col-container">
                    <label>Thu sổ đoàn</label>
                    <select id="notebook" required>
                        <option value="Đoàn trường nhận" selected>Đoàn trường nhận</option>
                        <option value="Đoàn khoa nhận">Đoàn khoa nhận</option>
                        <option value="Chi đoàn nhận">Chi đoàn nhận</option>
                        <option value="Chưa rút sổ">Chưa rút sổ</option>
                        <option value="Mất sổ">Mất sổ</option>
                        <option value="Chưa kết nạp Đoàn">Chưa kết nạp Đoàn</option>
                    </select>
                </div>
            </div>

            <div class="flex-row-container">
                <div class="flex-col-container">
                    <label>Ghi chú</label>
                    <input type="text" placeholder="Nhập ghi chú (nếu có)" id="note">
                </div>
            </div>

            <div class="flex-row-container right">
                <div style="text-align: left; flex: 1; color: var(--theme-color-1); font-weight: 500;">
                    <p>Xử lí nghiệp vụ: 0XXX.XXX.XXX (Đ/c ...)</p>
                    <p>Xử lí nghiệp vụ: 0XXX.XXX.XXX (Đ/c ...)</p>
                    <p>Phiên bản:2025.09.1</p>
                </div>
                <button type=" button" id="logoutBtn" style="background-color: red;">ĐĂNG XUẤT</button>
                <button type="reset" id="resetBtn">LÀM MỚI</button>
                <button type="submit" id="submitBtn" class="primary">THU PHÍ</button>
            </div>
        </form>
    </div>
</body>

<script type="module">
    import { formatMoney } from '../util/formatMoney.js';
    import { connectGAS } from '../util/connectGAS.js';


    const form = document.getElementById("studentForm");
    const logoutBtn = document.getElementById("logoutBtn");
    const mssvInput = document.getElementById("mssv");
    const sttInput = document.getElementById("stt");
    const lastnameInput = document.getElementById("lastname");
    const firstnameInput = document.getElementById("firstname");
    const facultyInput = document.getElementById("faculty");
    const classInput = document.getElementById("class");
    const monthSelect = document.getElementById("month");
    const yearSelect = document.getElementById("year");
    const feeInput = document.getElementById("fee");
    const noteBookInput = document.getElementById("noteBook");
    const noteInput = document.getElementById("note");

    document.addEventListener("DOMContentLoaded", startPage)

    // Khởi chạy
    function startPage() {
        mssvInput.addEventListener("input", getInfoStudent);
        monthSelect.addEventListener("change", computeFee);
        yearSelect.addEventListener("change", computeFee);
    }


    // Lấy dữ liệu sinh viên
    async function getInfoStudent() {
        if (mssvInput.value.length !== 8) return;

        const mssv = mssvInput.value;
        console.log({ mssv });

        try {
            const result = await connectGAS("getInfoStudent", { mssv });
            console.log(result);

            if (result.success) {
                // Ví dụ: điền thông tin sinh viên vào form
                sttInput.value = result.data.stt || '';
                lastnameInput.value = result.data.lastname || '';
                firstnameInput.value = result.data.firstname || '';
                facultyInput.value = result.data.faculty || '';
                classInput.value = result.data.class || '';
                computeFee();
            } else {
                alert(result.message || "Không tìm thấy sinh viên");
            }

        } catch (error) {
            console.error("Lỗi khi lấy thông tin sinh viên:", error);
            alert("Có lỗi xảy ra khi lấy dữ liệu");
        }
    }


    // Tính đoàn phí
    function computeFee() {
        const mssv = mssvInput.value;
        const year = yearSelect.value;
        const month = monthSelect.value;

        if (!mssv || !year || !month) {
            return;
        }

        const yearNum = parseInt(year, 10);
        const monthNum = parseInt(month, 10);

        const yearTemp = 2000 + parseInt(mssv.substring(1, 3), 10);
        const distance = (yearTemp * 12 + 8) - (yearNum * 12 + monthNum);
        const fee = (distance > 0) ? distance * 2000 + 96000 : 96000;

        feeInput.value = formatMoney(fee);

        return fee;
    }

    form.addEventListener("submit", async function (event) {
        event.preventDefault();

        const mssv = mssvInput.value;
        const notebook = noteBookInput.value;
        const month = monthSelect.value;
        const year = yearSelect.value;
        const note = noteInput.value;
        const fee = computeFee();

        // Kiểm tra dữ liệu bắt buộc
        if (mssv.length !== 8 || !month || !year) {
            alert("Vui lòng nhập đầy đủ dữ liệu hợp lệ.");
            return;
        }

        try {
            const result = await connectGAS("collectFee", { mssv, month, year, fee, note, notebook })
            console.log(result);

            if (result.success) {
                alert(result.message);
                form.reset();
            } else {
                alert(result.message || "Không thể thu Đoàn phí");
            }

        } catch (error) {
            console.error("Lỗi khi thu đoàn phi:", error);
            alert("Có lỗi xảy ra khi lấy dữ liệu");
        }
    });

    logoutBtn.addEventListener("click", () => {
        sessionStorage.clear();
        window.location.href = "/doan-phi";
    })
</script>

</html>